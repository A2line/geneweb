<!-- $Id: tree_build.txt,v 5.5 2017-07-25 13:15:18 hg Exp $ -->

<script type="text/javascript" src="%if;(cgi)%bvar.static_path;%end;jquery.min.js"></script>
<script type="text/javascript" src="%if;(cgi)%bvar.static_path;%end;templm/jquery.line.js"></script>
<script type="text/javascript" src="%if;(cgi)%bvar.static_path;%end;templm/js_upd.js"></script>
<script type="text/javascript" src="%if;(cgi)%bvar.static_path;%end;templm/js_upd_jq.js"></script>
<script src=%if;(cgi)%bvar.static_path;%end;templm/js.js></script>
%if;(bvar.uppercase = "yes")
  <script>
  <!--
    %if;(bvar.uppercase = "yes")
      %if;(bvar.particles != "")
        var p_a = new Array(%bvar.particles;);
      %else;
        var p_a = new Array("AF","AV","D","DAL","DE","DEN","DES","DI","DU","OF","UND","VAN","VON","ZU","ZUR");
      %end;
    %end;
  -->
  </script>
  <script src=%if;(cgi)%bvar.static_path;%end;templm/js_uppercase.js></script>
%else;
  <script src=%if;(cgi)%bvar.static_path;%end;templm/js_uppercase_no.js></script>
%end;

%import;templm/updind_updfam;

<div class="container-fluid">
<div class="row">
<div class="col-6">
<h1>%nn;
[
en: Interactive tree or graph build-up
fr: Construction interactive d'un arbre ou d'un graphe
]
</h1>

<script type="text/javascript">
    function hg_menu(zz,fn,sn,oc,ss,ii,tt)
    {
      var j = zz;
      if (j==null) { j = 0 };
      var idfn   = "fn"+j;
      var idsn   = "sn"+j;
      var idoc  = "oc"+j;
      var idss   = "sosa"+j;
      var idindx = "i"+j;
      var idtxt = "t"+j;
      localStorage.setItem(idfn, fn);
      localStorage.setItem(idsn, sn);
      localStorage.setItem(idoc, oc);
      localStorage.setItem(idss, ss);
      localStorage.setItem(idindx, ii);
      localStorage.setItem(idtxt, tt);
      oncontextmenu="return false";
      return true;
    }

    function hg_recode()
    {
      var olds = jQuery("#iz-string").val();
      var patt = /,/g;
      var news = olds.replace(patt, ";");
      jQuery("#iz-string").val(news);
      return true;
    }
    
    function hg_go()
    {
      var prevs = localStorage.getItem("is_string");
      if (prevs==null) { prevs = "" };
      var curs = jQuery("#is_string").val();
      var tmps = prevs+curs;
      var patt = /,/g;
      var news = tmps.replace(patt, ";");
      var oldHref = jQuery("#hg-href").attr('href');
      var newHref = oldHref+news;
      jQuery("#hg-href").attr('href', newHref);
      localStorage.setItem("is_string", tmps);
      localStorage.setItem("url", newHref);
      return true;
    }

    function hg_reload_g(name)
    {
      var id = "#"+name;
      var loc_name = localStorage.getItem(name);
      if (loc_name==null) { loc_name = "" };
      jQuery(id).val(loc_name);
      return true;
    }
    function hg_store_one(j)
    {
      var idfn   = "fn"+j;
      var idsn   = "sn"+j;
      var idoc  = "oc"+j;
      var idss   = "sosa"+j;
      var idindx = "i"+j;
      var idtxt = "t"+j;
      var idnfn   = "#fn"+j;
      var idnsn   = "#sn"+j;
      var idnoc  = "#oc"+j;
      var idnss   = "#sosa"+j;
      var idnindx = "#i"+j;
      var idntxt = "#t"+j;
      var fn = jQuery(idnfn).val();
      var sn = jQuery(idnsn).val();
      var oc = jQuery(idnoc).val();
      var sosa = jQuery(idnsosa).val();
      var indx = jQuery(idnindx).val();
      var txt = jQuery(idntxt).val();
      localStorage.setItem(idfn, fn);
      localStorage.setItem(idsn, sn);
      localStorage.setItem(idoc, oc);
      localStorage.setItem(idsosa, sosa);
      localStorage.setItem(idindx, indx);
      localStorage.setItem(idtxt, txt);
      localStorage.setItem("index", j);
      return true;
    }

    function hg_store_g(name)
    {
      var id = "#"+name;
      var loc_name = jQuery(id).val();
      localStorage.setItem(name, loc_name);
      return true;
    }
        
    function hg_store_to_url()
    {
      var url = window.location.search;
      var patt = /&/g;
      var urlb = url.replace(patt, ";").split(";");
      return true;
    }

    function hg_view_store()
    {
      var j = jQuery("#item").val();
      var idfn   = "fn"+j;
      var idsn   = "sn"+j;
      var idoc  = "oc"+j;
      var idss   = "sosa"+j;
      var idindx = "i"+j;
      var fn = localStorage.getItem(idfn);
      var sn = localStorage.getItem(idsn);
      var oc = localStorage.getItem(idoc);
      var sosa = localStorage.getItem(idss);
      var index = localStorage.getItem(idindx);
      jQuery("#store").html(j+": "+fn+" "+sn+" ("+oc+") "+sosa+", "+index);
      return true;
    }
    
    function hg_store_to_screen()
    {
      var i0 = jQuery("#item").val();
      for (j=0;j<100;j++)
      {
        var idfn   = "fn"+j;
        var idsn   = "sn"+j;
        var idoc  = "oc"+j;
        var idss   = "sosa"+j;
        var idindx = "i"+j;
        var idtxt = "t"+j;
        var id2fn   = "#fn"+j;
        var id2sn   = "#sn"+j;
        var id2oc  = "#oc"+j;
        var id2indx = "#i"+j;
        var id2txt = "#t"+j;
        var fn = localStorage.getItem(idfn);
        var sn = localStorage.getItem(idsn);
        var oc = localStorage.getItem(idoc);
        var sosa = localStorage.getItem(idss);
        var index = localStorage.getItem(idindx);
        var txt = localStorage.getItem(idtxt);
        jQuery(id2oc).val(oc);
        jQuery(id2fn).val(fn);
        jQuery(id2sn).val(sn);
        jQuery(id2indx).val(index);
        jQuery(id2txt).val(txt);
        if (fn=="" || fn == null) { break; }
      }
      return true;
    }

    function valid_key_i(kkk){for(i=0;i<100;i++){if (kkk == "i"+i) {return i}}return -1;}
    function valid_key_t(kkk){for(i=0;i<100;i++){if (kkk == "t"+i) {return i}}return -1;}
    
    function hg_url_to_store()
    {
      var patt = /&/g;
      var url = window.location.search.replace(patt, ";").split(";");
      for (j=0;j<100;j++)
      {
        var item = url[j].split("=");
        var key = String(item[0]); 
        var val = String(item[1]);
        var i = valid_key_i(key);
        var t = valid_key_t(key);
        if (i >= 0 || t >= 0)
        {
          var idfn = "fn"+i;
          var idsn = "sn"+i;
          var idoc = "oc"+i;
          var idss = "sosa"+i;
          var idindx = "i"+i;
          var idtxt = "t"+i;
          var id2fn = "#fn"+i;
          var id2sn = "#sn"+i;
          var id2oc  = "#oc"+i;
          var id2ss = "#sosa"+i;
          var id2indx = "#i"+i;
          var id2txt = "#t"+i;
          var fn = jQuery(id2fn).val();
          if (key == idfn) { if (fn=="" || fn == null) { fn = val };
            localStorage.setItem(idfn,fn); jQuery(id2fn).val(fn); };
          var sn = jQuery(id2sn).val();
          if (key == idsn) { if (sn=="" || sn == null) { sn = val };
            localStorage.setItem(idsn,sn); jQuery(id2sn).val(sn); };
          var oc = jQuery(id2oc).val();
          if (key == idoc) { if (oc=="" || oc == null) { oc = val };
            localStorage.setItem(idoc,oc); jQuery(id2oc).val(oc); };
          var sosa = jQuery(id2ss).val();
          if (key == idss) { if (sosa=="" || sosa == null) { sosa = val };
            localStorage.setItem(idss,sosa); jQuery(id2ss).val(sosa); };
          var index = jQuery(id2indx).val();
          if (key == idindx) { if (index=="" || index == null) { index = val };
            localStorage.setItem(idindx,index); jQuery(id2indx).val(index); };
          var txt = jQuery(id2txt).val();
          if (key == idtxt) { if (txt=="" || txt == null) { txt = val };
            localStorage.setItem(idtxt,txt); jQuery(id2txt).val(txt); };
        }
        if (key == idindx && i>=0 && (val == "" || val == null)) { break; }
      }
      return true;
    }
    
    function hg_no_store()
    {
      jQuery("#store").html("");
      return true;
    }

    function hg_view_url()
    {
      var hg_url = window.location.search;
      jQuery("#url").html("("+hg_url+")");
      return true;
    }

    function hg_no_url()
    {
      jQuery("#url").html("");
      return true;
    }
    
    function hg_clear_store()
    {
      for (j=0;j<100;j++) {
        var idfn   = "fn"+j;
        var idsn   = "sn"+j;
        var idoc  = "oc"+j;
        var idss   = "sosa"+j;
        var idindx = "i"+j;
        var idtxt = "t"+j;
        var id2fn   = "#fn"+j;
        var id2sn   = "#sn"+j;
        var id2oc  = "#oc"+j;
        var id2indx = "#i"+j;
        var id2txt = "#t"+j;
        localStorage.setItem(idfn, "");
        localStorage.setItem(idsn, "");
        localStorage.setItem(idoc, "");
        localStorage.setItem(idss, "");
        localStorage.setItem(idindx, "");
        localStorage.setItem(idtxt, "");
        jQuery(id2oc).val("");
        jQuery(id2fn).val("");
        jQuery(id2sn).val("");
        jQuery(id2indx).val("");
        jQuery(id2txt).val("");
      }
      localStorage.setItem("index", 0);
      localStorage.setItem("url", "");
      return true;
    }

    function hg_reset_iz()
    {
      jQuery('#iz-string').val("");
      return true;
    }

    function hg_set()
    {
      jQuery("#set_root").val("on");
      return true;
    }

    function hg_set_mode(mm)
    {
      jQuery("#mode").val(mm);
      return true;
    }

    function urlParam(name){
      var url = localStorage.getItem("url");
      var patt = /&/g;
      var urlb = url.replace(patt, ";");
      var results1 = new RegExp('[\?&]' + name + '=([^&#]*)').urlb;
      if (results1==null){ 
        if (name=="drm") {return "d"; }
        else { return null; } }
      else { return decodeURI(results1[1]) || 0; }
      return true;
    }
  </script>

%define;get_val(xx)
  <script type="text/javascript">
    jQuery( document ).ready(function( jQuery ) {
      jQuery(function() {
        var v = jQuery('#xx').val();
        window.alert('alert');
        console.log('TEST'+'\n');
    });
  });
  </script>
%end;

%define;one_param1(xx)
  %if;(evar.xx!="")xx=%evar.xx;;%end;%nn;
%end;

%define;one_param(xx,vv,ff)
  %if;(evar.xx!="" or "ff"="force")%nn;
    <input type=vv id="xx" name="xx" value="%evar.xx;">
  %end;
%end;

%define;one_p(xx)
  <input type="hidden" id="ixx" name="ixx" value="">
  <input type="hidden" id="txx" name="txx" value="">
%end;

%let;plist;/m/p/n/oc/pz/nz/ocz/i/sosa/image/marriage/t/t0/hi/cpl/scale/fs/wide/v/maxv/%nn;
            birth/birth_place/marr/marr_date/marr_place/child/death/death_place/death_age/%nn;
            num/ocu/gen/cgl//%in; %(33 %)

%define;rebuild_url_no_prfx()
  %let;url;%nn;
    %for;i;1;34;%nn;
      %apply;one_param1%with;%apply;nth%with;%plist;%and;%i;%end;%end;
    %end;%nn;
  %in;
  %url;
%end;

%if;not cancel_links;
  <div>
    %(include.home;%)
  </div>
%end;

Current i1, t1: %evar.i1;, %evar.t1;, %pvar.1.surname;<br>

%define;one_person(ccc)
  Fn: <input type="submit" id="ccc-fn" name="ccc-fn" style="width:10em" value="">
  Sn: <input type="submit" id="ccc-sn" name="ccc-sn" style="width:10em" value="">
  oc: <input type="submit" id="ccc-oc" name="ccc-oc" style="width:2em" value="">
  So: <input type="submit" id="ccc-sosa" name="ccc-sosa" style="width:4em" value="">
  Inx: <input type="submit" id="ccc-indx" name="ccc-indx" style="width:4em" value="">
  <br>
%end;

%define;one_pvar(z0, z1)
  %if;(evar.iz0!= "")
    %if;(evar.iz0!="no")
      <tr id="pz1">
        <td class="b1"><a tabindex="10000" href="javascript:addPvar(z1,0);">+</a></td>
        <td><input id="ocz1" name="ocz1" class="oc3" autocomplete="off" size="5" maxlength="8" value=""
             onkeypress="javascript:return oKP2(event,'p','z1','_oc','')"%/></td>
        <td class="b1"><a tabindex="10000" href="javascript:delS('p','z1','_oc',1,0,'');">x</a></td>
        <td><input id="fnz1" name="fnz1" class="ar" size="20" maxlength="200" value="" onblur="tUC1(this)"%/></td>
        <td><input id="snz1" name="snz1" size="20" maxlength="200" value="" onblur="tUC(this);jq1('z1','')"%/></td>
        %(<td class="b1"><a tabindex="10000" href="javascript:invertS('p','z1','_oc',0,1,'');">&uarr;</a></td>
        <td class="b1"><span id="pz1_jq1">
            %if;evar.z1.has_birth_date; %evar.z1.slash_birth_date;
            %elseif;evar.z1.has_baptism_date; %evar.z1.slash_baptism_date;
            %end;
             - %nn;
            %if;evar.z1.has_death_date;%evar.z1.slash_death_date; 
            %elseif;evar.z1.has_burial_date;%evar.z1.slash_burial_date; 
            %elseif;evar.z1.has_cremation_date;%evar.z1.slash_cremation_date; 
            %end;
          </span></td>
        <td class="b1"><a tabindex="10000" href="javascript:invertS('p','z1','_oc',1,1,'');">&darr;</a></td>%)
        <td><input id="iz1" name="iz1" value="" size="5"%/>
        <td><input id="tz1" name="tz1" size="20" maxlength="200" value="%evar.tz1;"%/></td>
      </tr>
      %apply;one_pvar(z0+1,z1+1)
    %else;
      %apply;one_pvar(z0+1,z1)
    %end;
  %end;
%end;

%define;get_imax(y)
  %if(evar.iy!="")%apply;get_imax(y+1)%else;y%end;
%end;
%let;imax;%apply;get_imax(1)%in;

<input type="hidden" id="set_root" name="set_root" value="">
<button type="submit" class="btn btn-light btn-sm" id="url_to_store" onclick="hg_url_to_store()"
  title="[*url_to_store]">Url to store</button>
<button type="submit" class="btn btn-light btn-sm" id="store_to_url" onclick="hg_store_to_screen()()"
  title="[*store_to_screen]">Store to screen</button>
<button type="submit" class="btn btn-light btn-sm" id="clear_store" onclick="hg_clear_store()"
  title="[*clear store]">Clear store</button>
<button type="submit" class="btn btn-light btn-sm" id="view" 
  onmouseover="hg_view_url()" onmouseout="hg_no_url()"
  title="[*view url]">View Url</button>

%if;(evar.mode="RLM")
  <input type="submit" class="btn btn-light btn-sm" id="tDAG" name="mode" value="DAG"
    onclick="hg_set_mode('DAG')"%/>
%else;
  <input type="submit" class="btn btn-light btn-sm" id="tRLM" name="mode" value="RLM"
    onclick="hg_set_mode('RLM')"%/>
%end;

<form id="upd" name="upd" method="get" action="%action;" onsubmit="oS1()">
  <div id="jq" style="display:none"> </div>
  <p style="display:none;">
    %hidden;
    <input type="hidden" name="m" value="RLM" %/>
    <input type="hidden" name="mode" value="%evar.mode;" %/>
    <input type="hidden" name="i0" value="%evar.i0;" %/>
    <input type="hidden" name="t0" value="%evar.t0;" %/>
    <input type="hidden" name="spouse" value="%evar.spouse;" %/>
    <input type="hidden" name="image" value="%evar.image;" %/>
    <input type="hidden" name="bd" value="%evar.bd;" %/>
    <input type="hidden" name="color" value="%evar.color;" %/>
    <input type="hidden" name="invert" value="%evar.invert;" %/>
    <input type="hidden" name="lim" value="%evar.lim;" %/>
    <input type="hidden" name="new" value="%evar.new;" %/>
  </p>
  <fieldset>
    <legend>[*modify::tree] <input type="submit" value="ok" %/></legend>
    <table id="upddag" summary="pvar" cellspacing=0 cellpadding=0>
      <tr>
        <td class="b1"><abbr title="[add::]">+</abbr></td>
        <td class="bg7"><abbr %lt4;>Occ</abbr></td>
        <td class="b1"><abbr title="[delete::]">x</abbr></td>
        <td class="bg7">[*first name/first names]0</td>
        <td class="bg7">[*surname/surnames]0</td>
        %(<td class="b1"><abbr title="[invert::] 3..2">&uarr;</abbr></td>
        <td class="bg7">[birth] - [death]</td>
        <td class="b1"><abbr title="[invert::] 2..3">&darr;</abbr></td>%)
        <td class="b1"><abbr title="Index">Index</abbr></td>
        <td class="bg7">[*text]</td>
      </tr>
      %if;(evar.i0!="")
        %apply;one_pvar(0,0)
      %else;
        %apply;one_pvar(1,1)
      %end;
      <tr id="new_pvar"></tr>
      <tr><td class="b1"><a id="add_pvar" style="display:block" href="javascript:addPvar(1,1)">+</a></td>
          <td colspan="8" class="b1"> </td>
      </tr>
    </table>
  </fieldset>
  %let;imax1;%expr(imax)%in;
  %let;imax2;%expr(imax+10)%in;
  %for;i;imax1;imax2;
    <input type="checkbox" id="chk%i;" name="chk%i;">
    <input type="input" id="oc%i;" name="oc%i;" value="" size="4"%/>
    <input type="input" id="fn%i;" name="fn%i;" value="" size="20"%/>
    <input type="input" id="sn%i;" name="sn%i;" value="" size="20"%/>
    <input type="input" id="i%i;" name="i%i;" value="" size="5"%/>
    <input type="input" id="t%i;" name="t%i;" value="" size="20"%/><br>
  %end;
</form>

View item:<br>
<input type="number" id="item" name="item" value="%imax;" style="width:3em">

<button type="submit" class="btn btn-light btn-sm" id="setroot" 
onclick="hg_menu(%imax;,'henri','gouraud',0,1,'1694','lui')">test</button>
<button type="submit" class="btn btn-light btn-sm" id="setroot" 
onmouseover="hg_view_store()" onmouseout="hg_no_store()">view</button>

<div id="store" name="store" style="width:60em"></div>
<div id="url" name="store" style="width:60em"></div>

<br>

</div>
<div class="col-6">
