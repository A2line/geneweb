<!-- $Id: perso_module/relations.txt v 7.00 20/11/2016 06:10:01 hg -->
%( op_m=1 Relations  %)
%( op_m=2 Relations complete (events) %)
%let;op_m;%if;(op_m!="")%op_m;%else;1%end;%in;


%define;implex()
  %if;(evar.implx="on")
    <script type="text/javascript">
    $(function() {
      $('#hi-tree1').line(%left1;, %top1;, %left2;, %top2;, {color:"red", stroke:1, opacity:0.3, zindex:1});
      });
    </script>
  %end;
%end;

<script type="text/javascript">
    function hg_raz_store()
    {
      for (j=0;j<100;j++) {
        var idfn   = "fn"+j;
        var idsn   = "sn"+j;
        var idoc  = "oc"+j;
        var idss   = "sosa"+j;
        var idindx = "i"+j;
        var idtxt = "t"+j;
        var id2fn   = "#fn"+j;
        var id2sn   = "#sn"+j;
        var id2oc  = "#oc"+j;
        var id2indx = "#i"+j;
        var id2txt = "#t"+j;
        localStorage.setItem(idfn, "");
        localStorage.setItem(idsn, "");
        localStorage.setItem(idoc, "");
        localStorage.setItem(idss, "");
        localStorage.setItem(idindx, "");
        localStorage.setItem(idtxt, "");
        jQuery(id2oc).val("");
        jQuery(id2fn).val("");
        jQuery(id2sn).val("");
        jQuery(id2indx).val("");
        jQuery(id2txt).val("");
      }
      localStorage.setItem("index", 0);
      localStorage.setItem("url", "");
      return true;
    }
    
    function hg_menu(zz,fn,sn,occ,ss,ii,tt)
    {
      var i = zz;
      if (i==null) { i = 0 };
      var idfn   = "fn"+i;
      var idsn   = "sn"+i;
      var idocc  = "oc"+i;
      var idss   = "sosa"+i;
      var idindx = "i"+i;
      var idtxt = "t"+i;
      localStorage.setItem(idfn, fn);
      localStorage.setItem(idsn, sn);
      localStorage.setItem(idocc, occ);
      localStorage.setItem(idss, ss);
      localStorage.setItem(idindx, ii);
      localStorage.setItem(idtxt, tt);
      oncontextmenu="return false";
      return true;
    }

    function hg_clear_store()
    {
    hg_raz_store();
    %reset_count;
    %let;text;%if;(sex=0)[him/her]0%elseif;(sex=1)[him/her]1%else;0%end;%in;
    hg_menu("%count;","%first_name;","%surname;","%occ;",1,"%index;","%text;");
    %foreach;relation;
      %if;(has_relation_him)
        %incr_count;
        hg_menu("%count;","%relation_him.first_name;","%relation_him.surname;",%nn;
          "%relation_him.occ;","1","%relation_him.index;","%relation_him.type;");
      %end;
      %if;(has_relation_her)
        %incr_count;
        hg_menu("%count;","%relation_her.first_name;","%relation_her.surname;",%nn;
          "%relation_her.occ;","1","%relation_her.index;","%relation_her.type;");
      %end;
    %end;
    %foreach;related;
      %incr_count;
      hg_menu("%count;","%related.first_name;","%related.surname;",%nn;
        "%related.occ;","1","%related.index;","%related_type;");
    %end;
    %foreach;event_witness_relation;
      %incr_count;%nn;
      hg_menu("%count;","%event_witness_relation.person.first_name;",%nn;
        "%event_witness_relation.person.surname;",%nn;
        "%event_witness_relation.person.occ;",%nn;
        "1","%event_witness_relation.person.index;","%event_witness_relation.event.name;");
    %end;
    %if;browsing_with_sosa_ref;
      %incr_count;%nn;
      hg_menu("%count;","%sosa_ref.first_name;","%sosa_ref.surname;",%nn;
        "%sosa_ref.occ;","1","%sosa_ref.index;","sosa_1");
    %end;
    %incr_count;
    hg_menu(%count;,"","","",1,"","");
    }
</script>

%define;relations_tree(z1)
  %( relations, related, witness at his event %)
  %reset_count;
  href="%prefix;spouse=on;m=RLM;mode=RLM;image=%evar.image;;%nn;
    i%count;=%index;;%nn;
    %let;text;%if;(sex=0)[him/her]0%elseif;(sex=1)[him/her]1%else;0%end;%in;
    t%count;=%text;;%nn;
    %foreach;relation;
      %if;(has_relation_him)
        %incr_count;i%count;=%relation_him.index;;%nn;
        t%count;=%relation_him.type;;%nn;
      %end;
      %if;(has_relation_her)
        %incr_count;i%count;=%relation_her.index;;%nn;
        t%count;=%relation_her.type;;%nn;
      %end;
    %end;
    %foreach;related;
      %incr_count;i%count;=%related.index;;%nn;
      t%count;=%related_type;;%nn;
    %end;
    %foreach;event_witness_relation;
      %incr_count;%nn;
      i%count;=%event_witness_relation.person.index;;%nn;
      t%count;=%event_witness_relation.event.name;;%nn;
    %end;
    %if;browsing_with_sosa_ref;
      %incr_count;%nn;
      i%count;=%sosa_ref.index;;%nn;
      t%count;=sosa_1;%nn;
    %end;
  "
  title="[*relations tree] (and witness at his event)"
  onclick="hg_clear_store()"
  %reset_count;
%end;

%reset_count;
%if;(bvar.module_perso_tplnb!="" and bvar.module_perso_tplnb>0)
  %for;i;0;bvar.module_perso_tplnb;
    %apply;test_templ(i)
  %end;
%elseif;(p_mod!="" and p_mod!="zz")
  %for;i;0;26;
    %apply;test_templ(i)
  %end;
%end;
%let;timeline;%if;(count>0)yes%else;no%end;%in;

%reset_count;
%( suppress relations and witnesses as they appear in timeline %)
%if;(timeline="no")
  %if;has_relations;%incr_count;%end;
  %foreach;event;%if;event.has_witnesses;%incr_count;%end;%end;
  %foreach;family;%if;has_witnesses;%incr_count;%end;%end;
%end;

%foreach;related;%incr_count;%end;
%foreach;event_witness_relation;%incr_count;%end;
%let;rel_nbr;%count;%in;

%if;(op_m=1 and has_relations)
  %reset_count;
  %foreach;relation;%if;(has_relation_him or has_relation_her)%incr_count;%end;%end;
  %foreach;related;%incr_count;%end;
  %foreach;event_witness_relation;%incr_count;%end;
  %let;cnt;%count;%in;
  %let;l_ref;%if;browsing_with_sosa_ref;%sosa_ref.index;%else;%index;%end;%in;
  <h2>[*relation/relations]1%nn;
    %if;(not cancel_links and cnt>1)
      <a %apply;relations_tree(l_ref)>%nn;
        <img class="ml-2 mb-1" src="%image_prefix;/gui_create.png" height="18" alt="Tree"%/>%nn;
      </a>%nn;
    %end;
  </h2>
  <ul>
  %foreach;relation;
    %if;(has_relation_him and has_relation_her)
      <li>%apply;capitalize(relation_type)[:]%nl;
        <ul>
          %apply;li_SDC("relation_him")
            %apply;short_display_person("relation_him")
          </li>
          %apply;li_SDC("relation_her")
            %apply;short_display_person("relation_her")
          </li>
        </ul>
      </li>
    %elseif;has_relation_him;
      %apply;li_SDC("relation_him")%apply;capitalize(relation_type)[:]%sp;
        %apply;short_display_person("relation_him")
      </li>
    %elseif;has_relation_her;
      %apply;li_SDC("relation_her")%apply;capitalize(relation_type)[:]%sp;
        %apply;short_display_person("relation_her")
      </li>
    %end;
  %end;
  %foreach;related;
    %apply;li_SDC("related")%apply;capitalize(related_type)[:]%sp;
      %apply;short_display_person("related")
    </li>
  %end;
  %foreach;event_witness_relation;
    %apply;li_SDC("event_witness_relation.person")
      %apply;capitalize(event_witness_relation_kind)%sp;
      %if;(event_witness_relation.event.date.year != "")
        <em>(%event_witness_relation.event.date.year;)</em>%end;
      [:]%sp;%event_witness_relation.event.name;,%sp;
      %apply;short_display_person("event_witness_relation.person")
      %if;(event_witness_relation.event.spouse != "")
        %sp;[and]
        %apply;short_display_person("event_witness_relation.event.spouse")
      %end;
    </li>
  %end;</ul>

%( not clear that relation_complete brings anything %)
%elseif;(op_m=2 and rel_nbr>0)
  %let;l_ref;%if;browsing_with_sosa_ref;%sosa_ref.index;%else;%index;%end;%in;
  <h2 id="relations" >[*relation/relations]1
  %if;(not cancel_links)
    <a %apply;relations_tree(l_ref)>
    <img src="%image_prefix;/gui_create.png" height="20" alt="Tree"/>
    </a>
  %end;
  </h2>
  <small>Relations_complete</small>

  <ul>
  %foreach;relation;
  %(godparents are displayed in timeline if has_event %)
    %if;(has_relation_him and has_relation_her
         and (timeline="no" or relation_type != [godfather/godmother/godparents]2 or not has_event))
      <li>%apply;capitalize(relation_type)[:]%nl;
        %apply;short_display_person("relation_him")
        ,%sp;
        %apply;short_display_person("relation_her").
      </li>
    %elseif;(has_relation_him and not has_relation_her
             and (timeline="no" or relation_type != [godfather/godmother/godparents]0 or not has_event))
      %apply;li_SDC("relation_him")%apply;capitalize(relation_type) :%sp;
      %apply;short_display_person("relation_him").
      </li>
    %elseif;(has_relation_her and not has_relation_him
             and (timeline="no" or relation_type != [godfather/godmother/godparents]1 or not has_event))
      %apply;li_SDC("relation_her")%apply;capitalize(relation_type) :%sp;
      %apply;short_display_person("relation_her").
      </li>
    %end;
  %end;

  %( treat differently godchild and others %)
  %foreach;related;
    %if;(related_type!=[godson/goddaughter/godchild]0 and
       related_type!=[godson/goddaughter/godchild]1 and
       related_type!=[godson/goddaughter/godchild]2)
      %apply;li_SDC("related")%apply;capitalize(related_type)[:]%sp;
      %apply;short_display_person("related").
    </li>
    %end;
  %end;
  %reset_count;
  %foreach;related;
    %if;(related_type=[godson/goddaughter/godchild]0 or
       related_type=[godson/goddaughter/godchild]1 or
       related_type=[godson/goddaughter/godchild]2)
      %incr_count;
    %end;
  %end;
  %let;g_cnt;%count;%in;
  %if;(g_cnt>0)
    <li>%if;(sex=0)[*godfather/godmother/godparents]0
         %elseif;(sex=1)[*godfather/godmother/godparents]1
         %else;[*godparent]%end; [of]%sp;
    %reset_count;
    %foreach;related;
      %if;(related_type=[godson/goddaughter/godchild]0 or
         related_type=[godson/goddaughter/godchild]1 or
         related_type=[godson/goddaughter/godchild]2)
        %apply;short_display_person("related")
        %incr_count;
        %if;(count=g_cnt).
        %else;
          %if;(count=g_cnt-1)%sp;[and]%sp;%else;,%sp;%end;
        %end;
      %end;
    %end;
    </li>
  %end;

  %foreach;event_witness_relation;
    %apply;li_SDC("event_witness_relation.person")
      %apply;capitalize(event_witness_relation_kind)%sp;
      (%event_witness_relation.event.name;%sp;
      %apply;short_display_person("event_witness_relation.person")
      %if;(event_witness_relation.event.spouse != "")
      %sp;[and]
      %apply;short_display_person("event_witness_relation.event.spouse")
      %end;)[:]%sp;%if;(sex=1)[him/her]1%else;[him/her]0%end;.
    </li>
  %end;

  %if;(timeline="no")
    %foreach;event;%sp;
      %if;(timeline="no" and (
           event.name!=[marriage event]))
        %reset_count;
        %foreach;event_witness;
          %incr_count;
        %end;
        %if;(count>0)
          <li>
          %if;(count=1)
            [*witness/witness/witnesses]0 (%event.name; %if;(sex=1)[him/her]1%else;[him/her]0%end;)[:]
          %else;
            [*witness/witness/witnesses]2 (%event.name; %if;(sex=1)[him/her]1%else;[him/her]0%end;)[:]
          %end;
          %foreach;event_witness;
            %if;not is_first;, %end;
            %if;(event_witness_kind=[officer/officer/officers]0)
              (%if;(event_witness.sex=1)[officer/officer/officers]1%else;[officer/officer/officers]0%end;)%sp;%end;
            %apply;short_display_person("event_witness")
          %end;
          </li>
        %end
      %end;
    %end;
  %end;
  </ul>
  %nl;
%end;
